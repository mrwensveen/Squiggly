<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href='https://fonts.googleapis.com/css?family=Rubik Mono One' rel='stylesheet'>
<style>
  body { background-color: #fff; }
  #canvases { position: relative; }
  #canvases canvas {
    position: absolute;
    top: 0;
    left: 0;
    visibility: hidden;
  }
  #canvases img {
    visibility: hidden;
    border: 1px solid black;
  }
  #instructions { text-align: center; }
  .licenses pre { font-size: .8em; }
</style>
<script type="module">

import level from './js/level.js';
import hud from './js/hud.js';
import hiscores from './js/hiscores.js';

// --- Player controls ---

// TODO: Separate this into a module

const INPUT = {
  keys: {},
  keyUpHandlers: []
}

document.addEventListener("keydown", event => {
  if (event.isComposing || event.keyCode === 229) {
    return;
  }
  
  INPUT.keys[event.keyCode] = true;
});

document.addEventListener("keyup", event => {
  if (event.isComposing || event.keyCode === 229) {
    return;
  }
  
  delete INPUT.keys[event.keyCode];

  if(INPUT.keyUpHandlers && INPUT.keyUpHandlers.length) {
    INPUT.keyUpHandlers.forEach(h => h && h(event));
  }
});

// --- Game elements ---

const WIDTH = 800, HEIGHT = 600;

const player = {
  img: null,
  position: null,
  health: 100,
  score: 0,
  level: 0
};

// --- Rendering stuff ---
const FPS = 30;
const FPS_INTERVAL = 1000 / FPS;

const render = {
  currentBuffer: 0,
  canvases: null
};

function flip(render) {
  render.canvases[1 - render.currentBuffer].style.visibility = 'hidden';
  render.canvases[render.currentBuffer].style.visibility = 'visible';

  render.currentBuffer = 1 - render.currentBuffer;
}

let start = 0;
function pump(timestamp)	{
  if (!start) start = timestamp;

  const dt = timestamp - start; // Time since previous frame

  if (dt > FPS_INTERVAL) {
    start = timestamp; // - (dt % FPS_INTERVAL);

    const renderContext = { ctx: render.canvases[render.currentBuffer].getContext('2d'), dt, start };

    if (player.health > 0) {
      level.step(player, INPUT, renderContext, { x: 0, y: 0, width: WIDTH, height: HEIGHT - 50 });
      hud.step(player, INPUT, renderContext, { x: 0, y: 550, width: WIDTH, height: HEIGHT - 550 });
    } else {
      hiscores.step(player, INPUT, renderContext, { x: 0, y: 0, width: WIDTH, height: HEIGHT });
    }

    // Show the drawn upon canvas
    flip(render);
  }
  
  // loop the shit out of this function
  window.requestAnimationFrame(pump);
}

// --- Initialize the game ---

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('start').addEventListener('click', function() {
    document.getElementById('instructions').style.display = 'none';
    document.getElementById('background').style.visibility = 'visible';

    const music = document.getElementById('music');
    music.play();

    let track = 0;
    music.addEventListener('ended', function() {
      track = (track + 1) % 3; // 3 is the number of songs (so far)
      let nextSong = `music_${(track + 1).toString().padStart(2, '0')}.mp3`;
      music.src = nextSong;
      music.load();
      music.play();
    }, false);
    
    // Add the player to the scene
    player.img = new Image();
    player.img.addEventListener('load', function() {
      player.position = {
        x: Math.floor(Math.random() * (WIDTH - player.img.width / 2)),
        y: Math.floor(Math.random() * (HEIGHT - player.img.height / 2))
      };
    });
    player.img.src = 'player.png';

    // now, wait a second!
    render.canvases = [document.getElementById('canvas1'), document.getElementById('canvas2')];
    window.requestAnimationFrame(pump);
  });
});
</script>
</head>
<body>
  <div id="instructions">
    <p>Press the arrow keys to move the player. Escape the sandworms until they starve.</p>
    <p>You monster.</p>
    <p>(You can only be bitten by the heads of the sandworms)</p>
    <button id="start">Start</button>
    <div class="licenses">
<!-- music_01.mp3 -->
<pre>
Bhangra Bass by Punch Deck | https://soundcloud.com/punch-deck
Music promoted by https://www.free-stock-music.com
Creative Commons Attribution 3.0 Unported License
https://creativecommons.org/licenses/by/3.0/deed.en_US
</pre>
<!-- music_02.mp3 -->
<pre>
Uncaria by Espionage | https://soundcloud.com/jelwooddj
Music promoted by https://www.free-stock-music.com
Creative Commons Attribution 3.0 Unported License
https://creativecommons.org/licenses/by/3.0/deed.en_US
</pre>
<!-- music_03.mp3 -->
<pre>
Inda by Benjamin Tissot | https://www.bensound.com/royalty-free-music/track/india
</pre>
<!-- boss_01.mp3 -->
<pre>
Sandstorm by Alexander Nakarada | https://www.serpentsoundstudios.com
Music promoted by https://www.free-stock-music.com
Attribution 4.0 International (CC BY 4.0)
https://creativecommons.org/licenses/by/4.0/
</pre>
    </div>
  </div>
  <div id="canvases">
    <img id="background" src="bg.png" width="800" height="600" />
    <canvas id="canvas1" width="800" height="600"></canvas>
    <canvas id="canvas2" width="800" height="600"></canvas>
  </div>
  <audio id="music" src="music_01.mp3"></audio>
</body>
</html>
