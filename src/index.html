<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Squiggly!</title>
<link href='https://fonts.googleapis.com/css?family=Rubik Mono One' rel='stylesheet'>
<style>
  body { background-color: #fff; font-family: Arial, Helvetica, sans-serif;}
  #canvases { position: relative; width: 800px; height: 600px; cursor: none; display: none; }
  #canvases canvas {
    position: absolute;
    top: 0;
    left: 0;
    visibility: hidden;
    width: 100%;
    height: 100%;
  }
  #canvases img {
    visibility: hidden;
    width: 100%;
    height: 100%;
  }
  #instructions { text-align: center; }
  .licenses pre { font-size: .8em; }
</style>
<script>
  const SOCKET_SERVER = `${window.location.protocol}//${window.location.hostname}:8081`;

  {
    const socketScriptElement = document.createElement('script');
    socketScriptElement.setAttribute('src', `${SOCKET_SERVER}/socket.io/socket.io.js`);
    document.head.appendChild(socketScriptElement);
  }
</script>

<script type="module">

import lobby from './js/stages/lobby.js';
import level from './js/stages/level.js';
import hud from './js/stages/hud.js';
import hiscores from './js/stages/hiscores.js';

// --- Player controls ---

import INPUT from './js/input.js'

// --- Game elements ---

let clientIndex = 0;

const WIDTH = 800, HEIGHT = 600;

const NETWORK = {
  socket: null,
  isHost: true,
};

const PLAYERS = [];

// --- Rendering stuff ---
const FPS = 30;
const FPS_INTERVAL = 1000 / FPS;

let canvas = null;

let start = 0;
function pump(timestamp)	{
  if (!start) start = timestamp;

  const dt = timestamp - start; // Time since previous frame

  if (dt > FPS_INTERVAL) {
    start = timestamp; // - (dt % FPS_INTERVAL);

    const context = {
      network: NETWORK,
      renderContext: { ctx: canvas.getContext('2d'), dt, start },
      input: INPUT,
      players: PLAYERS,
      clientIndex
    };

    if (PLAYERS.some(player => !player.ready)) {
      lobby.step(context, { x: 0, y: 0, width: WIDTH, height: HEIGHT - 50 }); // context, area
    }
    else if (PLAYERS.some(player => player.health > 0)) {
      level.step(context, { x: 0, y: 0, width: WIDTH, height: HEIGHT - 50 }); // context, area
      hud.step(context, { x: 0, y: 550, width: WIDTH, height: HEIGHT - 550 });
    } else {
      hiscores.step(context, { x: 0, y: 0, width: WIDTH, height: HEIGHT });
    }
  }

  // loop the shit out of this function
  window.requestAnimationFrame(pump);
}

function toggleFullscreen() {
  const elem = document.getElementById('canvases');

  if (!document.fullscreenElement) {
    elem.requestFullscreen().catch(err => {
      alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
    });
  } else {
    document.exitFullscreen();
  }
}

// --- Initialize the game ---

function initializeAndStart(beforeStart = player => {}) {
  document.getElementById('instructions').style.display = 'none';
  document.getElementById('canvases').style.display = 'block';

  document.getElementById('background').style.visibility = 'visible';
  document.getElementById('canvas').style.visibility = 'visible';

  const music = document.getElementById('music');
  //music.play();

  let track = 0;
  music.addEventListener('ended', function() {
    track = (track + 1) % 3; // 3 is the number of songs (so far)
    let nextSong = `music_${(track + 1).toString().padStart(2, '0')}.mp3`;
    music.src = nextSong;
    music.load();
    music.play();
  }, false);

  // Initialize the player
  const player = {
    img: new Image(),
    position: null,
    health: window.location.hash === '#test' ? 10 : 100,
    score: 0,
    level: 0,
    powerup: null,
    ready: true
  };

  PLAYERS[clientIndex] = player;

  player.img.addEventListener('load', function() {
    // TODO: Don't scale the player sprite.
    // Scale the player sprite
    player.img.width /= 2;
    player.img.height /= 2;

    player.position = {
      x: Math.floor(Math.random() * (WIDTH - player.img.width)),
      y: Math.floor(Math.random() * (HEIGHT - 50 - player.img.height)) // Mind the HUD
    };

    canvas = document.getElementById('canvas');
    //toggleFullscreen();

    // Allow for changes just before starting
    beforeStart(player);

    // Start the rendering pump on the next animation frame
    window.requestAnimationFrame(pump);
  });
  player.img.src = 'player.png';
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('start').addEventListener('click', function() {

    // If the user put a value in the game_name field, connect to socket.io and join the room with that name
    const gameName = document.getElementById('game_name').value;
    if (gameName) {
      // Connect to the socket server and join the game's room
      const socket = io(SOCKET_SERVER, {
        query: { room: gameName }
      });

      socket.on("connect", () => {
        NETWORK.socket = socket;
      });

      socket.on("welcome", data => {
        console.log("welcome", data);
        clientIndex = Number.parseInt(data);

        NETWORK.isHost = clientIndex === 0;
        initializeAndStart(player => {
          player.ready = false;

          // Announce your initial position
          socket.emit("announce", { i: clientIndex, position: player.position });
        });
      });

      socket.on("announce", data => {
        console.log("announce", data);

        // A challenger has arrived!
        const {i: remoteIndex, ...remotePlayer} = data;

        // Add the remote player to the PLAYERS array
        if (!PLAYERS[remoteIndex]) {
          // Create a copy of the local player and set any remote player data
          const localPlayer = PLAYERS[clientIndex];
          PLAYERS[remoteIndex] = { ...localPlayer, ...remotePlayer};

          // Announce your initial position to the new player
          socket.emit("announce", { i: clientIndex, position: localPlayer.position });
        }
      });

      socket.on("step", data => {
        console.log("step", data);
      });
    } else {
      initializeAndStart();
    }
  });
});
</script>
</head>
<body>
  <div id="instructions">
    <p>Press the <strong>arrow keys</strong> to move the player and <strong>shift</strong> to use the speed boost.</p>
    <p>Escape the sandworms until they starve.<br/>You monster.</p>
    <p>(You can only be bitten by the heads of the sandworms)</p>
    <p>Host/join multi-player game: <input id="game_name" placeholder="Game name..." /></p>
    <button id="start">Start</button>
    <div class="licenses">
<!-- music_01.mp3 -->
<pre>
Bhangra Bass by Punch Deck | https://soundcloud.com/punch-deck
Music promoted by https://www.free-stock-music.com
Creative Commons Attribution 3.0 Unported License
https://creativecommons.org/licenses/by/3.0/deed.en_US
</pre>
<!-- music_02.mp3 -->
<pre>
Uncaria by Espionage | https://soundcloud.com/jelwooddj
Music promoted by https://www.free-stock-music.com
Creative Commons Attribution 3.0 Unported License
https://creativecommons.org/licenses/by/3.0/deed.en_US
</pre>
<!-- music_03.mp3 -->
<pre>
Inda by Benjamin Tissot | https://www.bensound.com/royalty-free-music/track/india
</pre>
<!-- boss_01.mp3 -->
<pre>
Sandstorm by Alexander Nakarada | https://www.serpentsoundstudios.com
Music promoted by https://www.free-stock-music.com
Attribution 4.0 International (CC BY 4.0)
https://creativecommons.org/licenses/by/4.0/
</pre>
    </div>
  </div>
  <div id="canvases">
    <img id="background" src="bg.png" width="800" height="600" />
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>
  <audio id="music" src="music_01.mp3"></audio>
</body>
</html>
